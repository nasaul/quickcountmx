---
title: "Model calibration"
author: "Teresa Ortiz"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>", 
    cache = TRUE
)
```

To install the package use [devtools](https://github.com/r-lib/devtools) 
(devtools is available on CRAN).

```{r, message=FALSE}
# devtools::install_github("tereom/quickcountmx")
library(quickcountmx)
library(tidyverse)
```

The package includes the results of the 2012 Guanajuato Governor election, which
will be used to exemplify the functions.

```{r}
library(dplyr)
data("gto_2012")
dplyr::glimpse(gto_2012)
```

The variables are described in the package documentation `?gto_2012`.

## Examples: bayesian estimation

### Calibration for one model (vote count)


```{r}
counts <- mrp_party_estimation(gto_2012, party = pan_na, 
  stratum = distrito_loc_17, frac = 0.04, 
  seed = 211871, n_chains = 2, n_burnin = 500, n_iter = 1000, model_string = "model_bern_t")
qplot(counts$n_votes, binwidth = 1000) + 
  geom_vline(xintercept = sum(gto_2012$pan_na), colour ='red')
```

```{r}
R2jags::traceplot(counts$fit, varname = 'deviance')
```

Calibration run for one party (pan):

```{r}
gto_pan <- calibration_party(gto_2012, party = pan_na, frac = 0.075,
        stratum = distrito_loc_17, n_iter = 1500, n_burnin = 500, 
        cl_cores = 5, n_chains = 1, seed = 19112, n_rep = 5)
pan <- summary_calibration_party(gto_pan)
```

```{r}
pan$plot
pan$coverage
```

Calibration run for one party (prd):


```{r}
gto_prd <- calibration_party(gto_2012, party = prd, frac = 0.075,
        stratum = distrito_loc_17, n_iter = 1500, n_burnin = 500, 
        cl_cores = 5, n_chains = 1, seed = 19112, n_rep = 5)
prd <- summary_calibration_party(gto_prd)
```

```{r}
prd$plot
prd$coverage
```

## Calibration: bayesian estimation


## Calibration for vote proportion model

```{r, propcalib}
calibration_gto <- calibration_prop(gto_2012, pri_pvem:otros, frac = 0.02, 
        stratum = distrito_loc_17, n_iter = 1500, n_burnin = 500, 
        n_chains = 1, seed = 1911275, cl_cores = 1, n_rep = 5, 
        model_string = "model_bern_t")
```


```{r a}
calib_summary <- summary_calibration(calibration_gto)
calib_summary
```



### Coverage report for vote proportions with missing strata



```{r, propcalib2}
calibration_gto <- calibration_prop(gto_2012, pri_pvem:otros,
        frac = 0.075, stratum = distrito_loc_17, 
        n_iter = 1500, n_burnin = 500, 
        n_chains = 1, seed = 19331, cl_cores = 1, n_rep = 5, 
        model_string = "model_bern_t", num_missing_strata = 2)
```

```{r b}
calib_summary <- summary_calibration(calibration_gto)
calib_summary
```

## Calibration: Ratio estimation

### Coverage report for vote proportions  (ratio estimator)


```{r fddvv}
set.seed(1211)
gto_stratum_sizes <- gto_2012 %>%
  dplyr::group_by(distrito_loc_17) %>%
  dplyr::mutate(n_stratum = n())

calib_ratio <- parallel::mclapply(1:200, function(i) {
  mor_sample <- select_sample_prop(mor_stratum_sizes, stratum = distrito_loc_17, 
                                   0.075)
  ratio <- ratio_estimation(mor_sample, stratum = distrito_loc_17, 
                            n_stratum = n_stratum, ... = pri_pvem:otros)
  ratio <- ratio %>% mutate(n_sim = i)
  ratio 
}, mc.cores = 4) %>% bind_rows
```

```{r ddaee}
gto_gather <- gto_"012" %>% dplyr::select(casilla_id, pri_pvem:otros) %>%
  tidyr::gather(party, votes, pri_pvem:otros)
actual <- gto_gather %>% group_by(party) %>% 
  summarise(n_votes = sum(votes, na.rm = T)) %>%
  mutate(prop_votes = 100*n_votes/sum(n_votes, na.rm=T))
calib_ratio <- calib_ratio %>% left_join(actual) %>% ungroup() %>%
  mutate(coverage = r - 2*std_error < prop_votes & r + 2*std_error > prop_votes,
         precision = 2 * std_error)
```



```{r b}
ggplot(filter(calib_ratio, n_sim <= 200), aes(x = n_sim, y = r, ymin = r - 2*std_error,
       ymax = r + 2*std_error )) + geom_linerange(colour='red') +
  geom_hline(data = actual, aes(yintercept = prop_votes)) + 
  facet_wrap(~party, scales="free_y")
```

### Coverage report for vote proportions with missing strata (ratio estimator)


```{r f2}
set.seed(1211)
mor_stratum_sizes <- mor_2012_f %>%
  dplyr::group_by(distrito_loc_17) %>%
  dplyr::mutate(n_stratum = n())
mor_stratum_sizes <- mor_stratum_sizes %>% filter(!is.na(pri_pvem_pna) & !is.na(prd_pt_mc) & !is.na(pan) & !is.na(psd) & !is.na(otros) )
calib_ratio <- parallel::mclapply(1:200, function(i) {
  mor_sample <- select_sample_prop(mor_stratum_sizes, stratum = distrito_loc_17, 
                                   0.075)
  ratio <- ratio_estimation(mor_sample, stratum = distrito_loc_17, 
                            n_stratum = n_stratum, ... = pri_pvem_pna:otros)
  ratio <- ratio %>% mutate(n_sim = i)
  ratio 
}, mc.cores = 30) %>% bind_rows
```

```{r d2}
mor_gather <- mor_2012_f %>% dplyr::select(casilla_id, pri_pvem_pna:otros) %>%
  tidyr::gather(party, votes, pri_pvem_pna:otros)
actual <- mor_gather %>% group_by(party) %>% summarise(n_votes = sum(votes, na.rm = T)) %>%
  mutate(prop_votes = 100*n_votes/sum(n_votes, na.rm=T))
calib_ratio <- calib_ratio %>% left_join(actual) %>% ungroup() %>%
  mutate(coverage = r - 2*std_error < prop_votes & r + 2*std_error > prop_votes,
         precision = 2 * std_error)
```



```{r b2}
ggplot(filter(calib_ratio, n_sim <= 200), aes(x = n_sim, y = r, ymin = r - 2*std_error,
       ymax = r + 2*std_error )) + geom_linerange(colour='red') +
  geom_hline(data = actual, aes(yintercept = prop_votes)) + 
  facet_wrap(~party, scales="free_y")
```
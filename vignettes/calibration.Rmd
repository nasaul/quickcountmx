---
title: "Model calibration"
author: "Teresa Ortiz"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>", 
    cache = TRUE
)
```

To install the package use [devtools](https://github.com/r-lib/devtools) 
(devtools is available on CRAN).

```{r, message=FALSE}
# devtools::install_github("tereom/quickcountmx")
library(quickcountmx)
library(tidyverse)
```

The package includes the results of the 2012 Guanajuato Governor election, which
will be used to exemplify the functions.

```{r}
library(dplyr)
data("gto_2012")
dplyr::glimpse(gto_2012)
```

The variables are described in the package documentation `?gto_2012`.



## Calibration for one model (vote count)

Posterior predictive check for one run:

```{r}
counts <- mrp_party_estimation(gto_2012, party = pan_na, 
  stratum = distrito_loc_17, frac = 0.04, 
  seed = 211871, n_chains = 2, n_burnin = 500, n_iter = 1000, model_string = "model_bern_t")
qplot(counts$n_votes, binwidth = 1000) + 
  geom_vline(xintercept = sum(gto_2012$pan_na), colour ='red')
```

```{r}
R2jags::traceplot(counts, varname = 'deviance')
```

Calibration run for one party (pan):

```{r}
gto_pan <- calibration_party(gto_2012, party = pan_na, frac = 0.075,
        stratum = distrito_loc_17, n_iter = 1500, n_burnin = 500, 
        cl_cores = 2, n_chains = 1, seed = 19112, n_rep = 5)
pan <- summary_calibration_party(gto_pan)
pan$plot
pan$coverage
```

Calibration run for one party (prd):


```{r}
gto_prd <- calibration_party(gto_2012, party = prd, frac = 0.075,
        stratum = distrito_loc_17, n_iter = 1500, n_burnin = 500, 
        cl_cores = 2, n_chains = 1, seed = 19112, n_rep = 5)
prd <- summary_calibration_party(gto_prd)
prd$plot
prd$coverage
```



## Calibration for vote proportion model

```{r, propcalib}
calibration_gto <- calibration_prop(gto_2012, pri_pvem:otros, frac = 0.02, 
        stratum = distrito_loc_17, n_iter = 1500, n_burnin = 500, 
        n_chains = 1, seed = 1911275, cl_cores = 1, n_rep = 5, 
        model_string = "model_bern_t")
```


```{r a}
calib_summary <- summary_calibration(calibration_gto)
calib_summary
```



### Coverage report for vote proportions with missing strata



```{r, propcalib2}
calibration_gto <- calibration_prop(gto_2012, pri_pvem:otros,
        frac = 0.075, stratum = distrito_loc_17, 
        n_iter = 1500, n_burnin = 500, 
        n_chains = 1, seed = 19331, cl_cores = 1, n_rep = 5, 
        model_string = "model_bern_t", num_missing_strata = 10)
```

```{r a}
calib_summary <- calibration_gto %>% group_by(party) %>% 
  summarise(coverage = mean(coverage), 
  precision_media = mean(precision))
calib_summary
```
